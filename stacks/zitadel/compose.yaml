services:
  zitadel:
    image: ghcr.io/zitadel/zitadel:v4.10.1
    # Hardening: Run as non-root
    user: "1000"
    command: start-from-init --masterkeyFile /run/secrets/zitadel_masterkey #--config /zitadel.yaml
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.swarm.network=${TRAEFIK_NETWORK:-edge-external}"

        # --- Router: Main API & Console (HTTP/2) ---
        - "traefik.http.routers.zitadel.rule=Host(`${ZITADEL_HOSTNAME}`)"
        - "traefik.http.routers.zitadel.entrypoints=websecure"
        - "traefik.http.routers.zitadel.tls=true"
        - "traefik.http.routers.zitadel.service=zitadel-core"

        # --- Service: Core (h2c for gRPC support) ---
        - "traefik.http.services.zitadel-core.loadbalancer.server.port=8080"
        - "traefik.http.services.zitadel-core.loadbalancer.server.scheme=h2c"

    environment:
      # --- Networking ---
      - ZITADEL_EXTERNALDOMAIN=${ZITADEL_HOSTNAME}
      - ZITADEL_EXTERNALPORT=443
      - ZITADEL_EXTERNALSECURE=true
      - ZITADEL_TLS_ENABLED=false

      # --- Database ---
      - ZITADEL_DATABASE_POSTGRES_HOST=db
      - ZITADEL_DATABASE_POSTGRES_PORT=5432
      - ZITADEL_DATABASE_POSTGRES_DATABASE=zitadel
      - ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME=postgres
      - ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD_FILE=/run/secrets/zitadel_db_admin_password
      - ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE=disable
      - ZITADEL_DATABASE_POSTGRES_USER_USERNAME=zitadel
      - ZITADEL_DATABASE_POSTGRES_USER_PASSWORD_FILE=/run/secrets/zitadel_db_password
      - ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE=disable

      # --- Login V2 Configuration ---
      # We point these to the PUBLIC URL handled by Traefik
      - ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED=true
      - ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_BASEURI=https://${ZITADEL_HOSTNAME}/ui/v2/login
      - ZITADEL_OIDC_DEFAULTLOGINURLV2=https://${ZITADEL_HOSTNAME}/ui/v2/login/login?authRequest=
      - ZITADEL_OIDC_DEFAULTLOGOUTURLV2=https://${ZITADEL_HOSTNAME}/ui/v2/login/logout?post_logout_redirect=
      - ZITADEL_SAML_DEFAULTLOGINURLV2=https://${ZITADEL_HOSTNAME}/ui/v2/login/login?samlRequest=

      # --- Token Generation for Sidecar ---
      - ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH=/shared-config/login-client.pat
      - ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE=2029-01-01T00:00:00Z

      # --- Admin User Setup ---
      - ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME=${ZITADEL_ADMIN_USER:-admin}
      - ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD_FILE=/run/secrets/zitadel_admin_password

    volumes:
      # Share the generated config with the login container
      - zitadel-shared-config:/shared-config
    networks:
      - ${TRAEFIK_NETWORK:-edge-external}
      - zitadel-backend
    secrets:
      - zitadel_masterkey
      - zitadel_db_password
      - zitadel_db_admin_password
      - zitadel_admin_password
    healthcheck:
      test: ["CMD", "/app/zitadel", "ready"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Security: Read Only + Tmpfs
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m
    cap_drop:
      - ALL

  login:
    image: ghcr.io/zitadel/zitadel-login:v4.10.1
    user: "1000"
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.swarm.network=${TRAEFIK_NETWORK:-edge-external}"

        # --- Router: Login V2 Specific Path ---
        # Routes /ui/v2/login to this container
        - "traefik.http.routers.zitadel-login.rule=Host(`${ZITADEL_HOSTNAME}`) && PathPrefix(`/ui/v2/login`)"
        - "traefik.http.routers.zitadel-login.entrypoints=websecure"
        - "traefik.http.routers.zitadel-login.tls=true"
        - "traefik.http.routers.zitadel-login.service=zitadel-login"

        # --- Service: HTTP (NextJS) ---
        - "traefik.http.services.zitadel-login.loadbalancer.server.port=3000"

    environment:
      # Use DNS name 'zitadel' (Service Discovery), not localhost!
      - ZITADEL_API_URL=http://zitadel:8080
      - NEXT_PUBLIC_BASE_PATH=/ui/v2/login
      # Read the token generated by the main container
      - ZITADEL_SERVICE_USER_TOKEN_FILE=/shared-config/login-client.pat
      - CUSTOM_REQUEST_HEADERS=Host:${ZITADEL_HOSTNAME}
    volumes:
      - zitadel-shared-config:/shared-config:ro
    networks:
      - ${TRAEFIK_NETWORK:-edge-external}
      - zitadel-backend
    read_only: true
    tmpfs:
      - /tmp:rw,size=50m

  db:
    image: postgres:17
    volumes:
      - db-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=zitadel
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD_FILE=/run/secrets/zitadel_db_admin_password
    networks:
      - zitadel-backend
    deploy:
      replicas: 1
    secrets:
      - zitadel_db_admin_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d zitadel"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  edge-external:
    external: true
    name: ${TRAEFIK_NETWORK:-edge-external}
  zitadel-backend:
    driver: overlay
    attachable: false

volumes:
  # This volume acts as the bridge to pass the PAT token
  # from 'zitadel' to 'login' since we can't use network_mode: service
  zitadel-shared-config:
  db-data:

secrets:
  zitadel_masterkey:
    external: true
  zitadel_db_password:
    external: true
  zitadel_db_admin_password:
    external: true
  zitadel_admin_password:
    external: true
