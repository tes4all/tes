version: '3.8'

networks:
  postgres-ha:
    driver: overlay
    attachable: true

volumes:
  etcd-1-data:
  etcd-2-data:
  etcd-3-data:
  postgres-1-data:
  postgres-2-data:
  postgres-3-data:
  pgbackrest-data:

services:
  # etcd cluster for Patroni consensus
  etcd-1:
    image: quay.io/coreos/etcd:v3.5.11
    networks:
      - postgres-ha
    environment:
      - ETCD_NAME=etcd-1
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd-1:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd-1:2379
      - ETCD_INITIAL_CLUSTER=etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=postgres-ha-cluster
    volumes:
      - etcd-1-data:/etcd-data
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  etcd-2:
    image: quay.io/coreos/etcd:v3.5.11
    networks:
      - postgres-ha
    environment:
      - ETCD_NAME=etcd-2
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd-2:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd-2:2379
      - ETCD_INITIAL_CLUSTER=etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=postgres-ha-cluster
    volumes:
      - etcd-2-data:/etcd-data
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  etcd-3:
    image: quay.io/coreos/etcd:v3.5.11
    networks:
      - postgres-ha
    environment:
      - ETCD_NAME=etcd-3
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd-3:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd-3:2379
      - ETCD_INITIAL_CLUSTER=etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=postgres-ha-cluster
    volumes:
      - etcd-3-data:/etcd-data
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Patroni Postgres nodes
  postgres-1:
    build:
      context: .
      dockerfile: Dockerfile.patroni
    image: postgres-ha/patroni:16.1
    hostname: postgres-1
    networks:
      - postgres-ha
    environment:
      - PATRONI_NAME=postgres-1
      - PATRONI_SCOPE=postgres-cluster
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=postgres-1:5432
      - PATRONI_RESTAPI_CONNECT_ADDRESS=postgres-1:8008
      - HOSTNAME=postgres-1
    volumes:
      - postgres-1-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
      - "8008:8008"
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
      resources:
        limits:
          cpus: '1'
          memory: 1G
      labels:
        - "prometheus.scrape=true"
        - "prometheus.port=8008"
        - "prometheus.path=/metrics"
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    depends_on:
      - etcd-1
      - etcd-2
      - etcd-3

  postgres-2:
    build:
      context: .
      dockerfile: Dockerfile.patroni
    image: postgres-ha/patroni:16.1
    hostname: postgres-2
    networks:
      - postgres-ha
    environment:
      - PATRONI_NAME=postgres-2
      - PATRONI_SCOPE=postgres-cluster
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=postgres-2:5432
      - PATRONI_RESTAPI_CONNECT_ADDRESS=postgres-2:8008
      - HOSTNAME=postgres-2
    volumes:
      - postgres-2-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
      - "8009:8008"
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
      resources:
        limits:
          cpus: '1'
          memory: 1G
      labels:
        - "prometheus.scrape=true"
        - "prometheus.port=8008"
        - "prometheus.path=/metrics"
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    depends_on:
      - etcd-1
      - etcd-2
      - etcd-3

  postgres-3:
    build:
      context: .
      dockerfile: Dockerfile.patroni
    image: postgres-ha/patroni:16.1
    hostname: postgres-3
    networks:
      - postgres-ha
    environment:
      - PATRONI_NAME=postgres-3
      - PATRONI_SCOPE=postgres-cluster
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=postgres-3:5432
      - PATRONI_RESTAPI_CONNECT_ADDRESS=postgres-3:8008
      - HOSTNAME=postgres-3
    volumes:
      - postgres-3-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
      - "8010:8008"
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
      resources:
        limits:
          cpus: '1'
          memory: 1G
      labels:
        - "prometheus.scrape=true"
        - "prometheus.port=8008"
        - "prometheus.path=/metrics"
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    depends_on:
      - etcd-1
      - etcd-2
      - etcd-3

  # Postgres Exporter for metrics
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    networks:
      - postgres-ha
    environment:
      - DATA_SOURCE_NAME=postgresql://postgres:postgres@postgres-1:5432/postgres?sslmode=require
    ports:
      - "9187:9187"
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "prometheus.scrape=true"
        - "prometheus.port=9187"
        - "prometheus.path=/metrics"
    cap_drop:
      - ALL
    depends_on:
      - postgres-1

  # pgBackRest for backups
  pgbackrest:
    build:
      context: .
      dockerfile: Dockerfile.pgbackrest
    image: postgres-ha/pgbackrest:latest
    networks:
      - postgres-ha
    volumes:
      - pgbackrest-data:/var/lib/pgbackrest
      - postgres-1-data:/var/lib/postgresql/data:ro
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 30s
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE
    depends_on:
      - postgres-1
