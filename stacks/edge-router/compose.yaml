# Edge Router Stack - HAProxy L4 + Traefik L7
# Golden Stack - Production Hardened, Swarm-Ready
name: edge-router

services:
  # ===========================================
  # HAProxy - L4 TCP Load Balancer (Global Mode)
  # ===========================================
  haproxy:
    image: tes4all/haproxy:${HAPROXY_VERSION:-3.3.1-alpine}
    hostname: haproxy-{{.Task.Slot}}
    networks:
      - edge-internal
      - edge-external
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
      - target: 8405
        published: 8405
        protocol: tcp
        mode: host
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=false"
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: stop-first
    labels:
      - "prometheus.scrape=true"
      - "prometheus.port=8405"
      - "prometheus.path=/metrics"

  # ===========================================
  # Traefik - L7 HTTP Reverse Proxy
  # ===========================================
  traefik:
    image: tes4all/traefik:${TRAEFIK_VERSION:-3.6.6}
    hostname: traefik-{{.Task.Slot}}
    configs:
      - source: traefik_static
        target: /etc/traefik/traefik.yml
    networks:
      - edge-internal
      - edge-external
    ports:
      - target: 8083 # Dashboard/Metrics
        published: 8083
        protocol: tcp
        mode: host
      - target: 8082 # Ping
        published: 8082
        protocol: tcp
        mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - acme-data:/certs # Shared volume for certs
    environment:
      - TZ=UTC
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    deploy:
      mode: replicated
      replicas: 3
      placement:
        constraints:
          - node.role == manager
        preferences:
          - spread: node.id
      labels:
        # Enable Traefik to route itself (dashboard)
        - "traefik.enable=true"
        - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.localhost`)"
        - "traefik.http.routers.traefik-dashboard.service=api@internal"
        - "traefik.http.routers.traefik-dashboard.entrypoints=web"

        # ROUTING CHALLENGE: Route /.well-known/acme-challenge/ to cert-manager
        - "traefik.http.routers.acme-challenge.rule=PathPrefix(`/.well-known/acme-challenge/`)"
        - "traefik.http.routers.acme-challenge.entrypoints=web"
        - "traefik.http.routers.acme-challenge.service=cert-manager-svc"
        - "traefik.http.services.cert-manager-svc.loadbalancer.server.port=8080"

        # Prometheus
        - "prometheus.scrape=true"
        - "prometheus.port=8083"
        - "prometheus.path=/metrics"
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.2"
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        order: stop-first

  # ===========================================
  # Cert Manager - Lego Controller
  # ===========================================
  cert-manager:
    image: goacme/lego:v4.14.2
    entrypoint: ["/bin/sh", "/config/cert-manager.sh"]
    networks:
      - edge-internal
      - edge-external
    configs:
      - source: cert_manager_script
        target: /config/cert-manager.sh
        mode: 0555
    volumes:
      - acme-data:/certs
    environment:
      - ACME_EMAIL=${ACME_EMAIL}

      # DNS-01 Provider Config
      # Set the provider name (e.g. infomaniak, route53, cloudflare)
      - LEGO_DNS_PROVIDER=${LEGO_DNS_PROVIDER:-infomaniak}

      # Configuration for the script
      - DOMAINS_WILDCARD=${DOMAINS_WILDCARD} # e.g. "my-company.com"
      - DOMAINS_CUSTOMER=${DOMAINS_CUSTOMER} # e.g. "foo.client.com,bar.client.com"
      - LEGO_SERVER=${LEGO_SERVER:-https://acme-v02.api.letsencrypt.org/directory}
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

networks:
  edge-internal:
    internal: true
  edge-external:
    attachable: true

volumes:
  acme-data:
    driver: local

configs:
  cert_manager_script:
    file: ./config/cert-manager.sh
  traefik_static:
    file: ./config/traefik.yaml
