services:
  vaultwarden:
    image: tes4all/vaultwarden:${VAULTWARDEN_VERSION:-1.35.3-alpine}
    networks:
      - db-internal
      - proxy-public
      # Uncomment to use external postgres
      # - postgres-ha
    ports:
      # Expose port for standalone usage.
      - "${VAULTWARDEN_PORT:-8091}:8080"
    environment:
      # Database connection string
      # Default: Internal Postgres
      # External: postgresql://user:password@host:port/dbname
      # - DATABASE_URL=${DATABASE_URL:-postgresql://vaultwarden:secret@db:5432/vaultwarden}
      # Domain configuration
      - DOMAIN=${DOMAIN:-http://localhost:${VAULTWARDEN_PORT:-8091}}
      # Hardening
      - SIGNUPS_ALLOWED=${SIGNUPS_ALLOWED:-false}
      - WEBSOCKET_ENABLED=${WEBSOCKET_ENABLED:-true}
      # Internal port configuration (matches container port)
      - ROCKET_PORT=8080
    volumes:
      - vaultwarden-data:/data
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
      labels:
        # Edge Router (Traefik) Configuration
        - "traefik.enable=true"
        - "traefik.http.routers.vaultwarden.rule=Host(`${VAULTWARDEN_DOMAIN:-vault.example.com}`)"
        - "traefik.http.routers.vaultwarden.entrypoints=websecure"
        - "traefik.http.services.vaultwarden.loadbalancer.server.port=8080"
        - "traefik.http.routers.vaultwarden.service=vaultwarden"
        - "traefik.http.routers.vaultwarden.tls=true"
        # WebSocket Configuration
        - "traefik.http.routers.vaultwarden-ws.rule=Host(`${VAULTWARDEN_DOMAIN:-vault.example.com}`) && Path(`/notifications/hub`)"
        - "traefik.http.routers.vaultwarden-ws.entrypoints=websecure"
        - "traefik.http.routers.vaultwarden-ws.service=vaultwarden-ws"
        - "traefik.http.routers.vaultwarden-ws.tls=true"
        - "traefik.http.services.vaultwarden-ws.loadbalancer.server.port=3012"
        - "traefik.swarm.network=${TRAEFIK_NETWORK:-edge-external}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  db:
    image: postgres:18.2-alpine

    volumes:
      - db-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-vaultwarden}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secret}
      - POSTGRES_DB=${POSTGRES_DB:-vaultwarden}
    networks:
      - db-internal
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-vaultwarden}"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  # Network communicating with Traefik
  proxy-public:
    external: true
    name: ${TRAEFIK_NETWORK:-edge-external}
  # Private network between Vaultwarden and DB
  db-internal:
    driver: overlay
    attachable: false

volumes:
  vaultwarden-data:
  db-data:
