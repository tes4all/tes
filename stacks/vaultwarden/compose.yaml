name: vaultwarden

services:
  vaultwarden:
    image: tes4all/vaultwarden:${VAULTWARDEN_VERSION}
    networks:
      - default
      # Uncomment to use external edge router
      # - edge-router-net
      # Uncomment to use external postgres
      # - postgres-ha
    ports:
      # Expose port for standalone usage
      - "${PORT:-8080}:8080"
    environment:
      # Database connection string
      # Default: Internal Postgres
      # External: postgresql://user:password@host:port/dbname
      - DATABASE_URL=${DATABASE_URL:-postgresql://vaultwarden:secret@db:5432/vaultwarden}
      # Domain configuration
      - DOMAIN=${DOMAIN:-http://localhost:8080}
      # Hardening
      - SIGNUPS_ALLOWED=false
      - WEBSOCKET_ENABLED=true
    volumes:
      - vaultwarden-data:/data
    depends_on:
      db:
        condition: service_healthy
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        # Edge Router (Traefik) Configuration
        - "traefik.enable=true"
        - "traefik.http.routers.vaultwarden.rule=Host(`vault.example.com`)"
        - "traefik.http.routers.vaultwarden.entrypoints=websecure"
        - "traefik.http.routers.vaultwarden.tls.certresolver=myresolver"
        - "traefik.http.services.vaultwarden.loadbalancer.server.port=8080"
        # WebSocket Configuration
        - "traefik.http.routers.vaultwarden-ws.rule=Host(`vault.example.com`) && Path(`/notifications/hub`)"
        - "traefik.http.routers.vaultwarden-ws.entrypoints=websecure"
        - "traefik.http.routers.vaultwarden-ws.tls.certresolver=myresolver"
        - "traefik.http.services.vaultwarden-ws.loadbalancer.server.port=3012"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    cap_drop:
      - ALL

  db:
    image: postgres:15-alpine
    restart: always
    volumes:
      - db-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=vaultwarden
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=vaultwarden
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vaultwarden"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  default:
  # edge-router-net:
  #   external: true
  # postgres-ha:
  #   external: true

volumes:
  vaultwarden-data:
  db-data:
